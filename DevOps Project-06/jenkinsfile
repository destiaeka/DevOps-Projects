pipeline {
    agent any

    tools {
        jdk 'jdk17'
        nodejs 'node16'
    }

    environment {
        SCANNER_HOME = tool('sonar-scanner')
        PROJECT_DIR = 'DevOps Project-06'
    }

    stages {

        stage('Clean Workspace') {
            steps {
                cleanWs()
            }
        }

        stage('Checkout Source Code') {
            steps {
                dir(env.PROJECT_DIR) {
                    git branch: 'main',
                        url: 'https://github.com/destiaeka/DevOps-Projects.git',
                        credentialsId: 'github-token'
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                dir(env.PROJECT_DIR) {
                    withSonarQubeEnv('sonar-server') {
                        sh """
                        ${SCANNER_HOME}/bin/sonar-scanner \
                        -Dsonar.projectKey=Netflix \
                        -Dsonar.projectName=Netflix \
                        -Dsonar.sources=. \
                        -Dsonar.exclusions=**/*.java
                        """
                    }
                }
            }
        }

        stage('Quality Gate') {
            steps {
                script {
                    timeout(time: 5, unit: 'MINUTES') {
                        try {
                            def qg = waitForQualityGate()
                            echo "Quality Gate Status: ${qg.status}"

                            if (qg.status != 'OK') {
                                currentBuild.result = 'UNSTABLE'
                                echo "⚠️ Quality Gate failed but pipeline continues"
                            }

                        } catch (err) {
                            echo "SonarQube Quality Gate FAILED — ignored"
                            currentBuild.result = 'UNSTABLE'
                        }
                    }
                }
            }
        }

        stage('Build Application') {
            steps {
                dir(env.PROJECT_DIR) {
                    sh 'npm run build || true'
                }
            }
        }
    }

    post {
        always {
            emailext(
                attachLog: true,
                subject: "Build Result: ${currentBuild.result}",
                body: """
Project : ${env.JOB_NAME}
Build   : #${env.BUILD_NUMBER}
Status  : ${currentBuild.result}
URL     : ${env.BUILD_URL}
""",
                to: 'destiaeka38@gmail.com',
                attachmentsPattern: 'trivyfs.txt,trivyimage.txt'
            )
        }

        success {
            echo "✅ Pipeline completed successfully!"
        }

        unstable {
            echo "⚠️ Build unstable (Quality Gate failed but pipeline continued)"
        }

        failure {
            echo "❌ Pipeline failed. Check logs."
        }
    }
}
